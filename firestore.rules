rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userExists() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserRole() {
      return getUserDoc().data.role;
    }

    function isUserActive() {
      return getUserDoc().data.isActive != false;
    }

    // Combined checks - use these in rules
    function isAdmin() {
      return userExists() && getUserRole() == 'admin' && isUserActive();
    }

    function isManagerOrAdmin() {
      return userExists() && getUserRole() in ['admin', 'manager'] && isUserActive();
    }

    function isEditorOrHigher() {
      return userExists() && getUserRole() in ['admin', 'manager', 'editor'] && isUserActive();
    }

    function isActiveUser() {
      return userExists() && isUserActive();
    }

    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      // Users can read their own profile
      // Managers and Admins can read all user profiles
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        isManagerOrAdmin()
      );

      // Users can create their own profile on signup
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Users can update their own displayName and lastLogin
      // Managers and Admins can update other users
      allow update: if isSignedIn() && (
        (request.auth.uid == userId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'lastLogin'])) ||
        isManagerOrAdmin()
      );

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // ============================================
    // Invites Collection
    // ============================================
    match /invites/{inviteId} {
      // Read access:
      // - Managers and admins can read all invites for management
      // - Unauthenticated users can read pending invites (for magic link validation)
      //   Note: Token is unguessable, so discovery requires knowing the token first
      allow read: if isManagerOrAdmin() ||
                     (resource.data.status == "pending" &&
                      resource.data.expiresAt.toMillis() > request.time.toMillis());

      // Managers and Admins can create and update invites
      allow create, update: if isManagerOrAdmin();

      // Only admins can delete invites
      allow delete: if isAdmin();
    }

    // ============================================
    // Notifications Collection
    // ============================================
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // System can create notifications (authenticated users)
      allow create: if isSignedIn();

      // Users can update their own notifications (mark as read)
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Only admins can delete notifications
      allow delete: if isAdmin();
    }

    // ============================================
    // Email Queue Collection (for SendGrid)
    // ============================================
    match /emailQueue/{emailId} {
      // Only authenticated users can create emails
      allow create: if isSignedIn();

      // Only backend/admin can read and update
      allow read, update: if isAdmin();

      // No client-side deletes
      allow delete: if false;
    }

    // ============================================
    // Developments Collection
    // ============================================
    match /developments/{developmentId} {
      // Active users can read developments they have access to
      allow read: if isActiveUser() && canAccessDev(developmentId);

      // Only admins can write
      allow write: if isAdmin();

      function canAccessDev(devId) {
        let userData = getUserDoc().data;
        return userData.role == 'admin' ||
               userData.role == 'manager' ||
               !('allowedDevelopments' in userData) ||
               userData.allowedDevelopments == null ||
               userData.allowedDevelopments.size() == 0 ||
               devId in userData.allowedDevelopments;
      }
    }

    // ============================================
    // Units Sub-collection
    // ============================================
    match /developments/{developmentId}/units/{unitId} {
      allow read: if isActiveUser();
      allow update: if isEditorOrHigher();
      allow create, delete: if isAdmin();
    }

    // ============================================
    // Audit Logs
    // ============================================
    match /auditLogs/{logId} {
      allow read: if isManagerOrAdmin();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // ============================================
    // Notes Collection
    // ============================================
    match /notes/{noteId} {
      allow read: if isActiveUser();
      allow create: if isEditorOrHigher();
      allow update: if isActiveUser() && (
        resource.data.createdBy == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // Incentive Schemes
    // ============================================
    match /incentiveSchemes/{schemeId} {
      allow read: if isActiveUser();
      allow write: if isAdmin();
    }

    // ============================================
    // Settings
    // ============================================
    match /settings/{settingId} {
      allow read: if isActiveUser();
      allow write: if isAdmin();
    }

    // ============================================
    // Saved Reports
    // ============================================
    match /savedReports/{reportId} {
      // Users can read their own saved reports, admins can read all
      allow read: if isActiveUser() && (
        resource.data.createdBy == request.auth.uid || isAdmin()
      );
      // Users can create their own reports
      allow create: if isActiveUser() && request.resource.data.createdBy == request.auth.uid;
      // Users can update/delete their own reports, admins can update/delete all
      allow update, delete: if isActiveUser() && (
        resource.data.createdBy == request.auth.uid || isAdmin()
      );
    }

    // ============================================
    // Report Templates (custom templates)
    // ============================================
    match /reportTemplates/{templateId} {
      allow read: if isActiveUser();
      allow write: if isAdmin();
    }
  }
}
