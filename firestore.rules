rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function userExists() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserRole() {
      return getUserDoc().data.role;
    }

    function isUserActive() {
      return getUserDoc().data.isActive != false;
    }

    // Combined checks - use these in rules
    function isAdmin() {
      return userExists() && getUserRole() == 'admin' && isUserActive();
    }

    function isEditorOrAdmin() {
      return userExists() && getUserRole() in ['admin', 'editor'] && isUserActive();
    }

    function isActiveUser() {
      return userExists() && isUserActive();
    }

    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      // Users can read their own profile
      // Admins can read and query all user profiles
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        isAdmin()
      );

      // Users can create their own profile on signup
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Users can update their own displayName and lastLogin
      // Admins can update any user
      allow update: if isSignedIn() && (
        (request.auth.uid == userId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'lastLogin'])) ||
        isAdmin()
      );

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ============================================
    // Invites Collection
    // ============================================
    match /invites/{inviteId} {
      // Admins can read, create, update, delete invites
      allow read, write: if isAdmin();
    }

    // ============================================
    // Developments Collection
    // ============================================
    match /developments/{developmentId} {
      // Active users can read developments they have access to
      allow read: if isActiveUser() && canAccessDev(developmentId);

      // Only admins can write
      allow write: if isAdmin();

      function canAccessDev(devId) {
        let userData = getUserDoc().data;
        return userData.role == 'admin' ||
               !('allowedDevelopments' in userData) ||
               userData.allowedDevelopments == null ||
               userData.allowedDevelopments.size() == 0 ||
               devId in userData.allowedDevelopments;
      }
    }

    // ============================================
    // Units Sub-collection
    // ============================================
    match /developments/{developmentId}/units/{unitId} {
      allow read: if isActiveUser();
      allow update: if isEditorOrAdmin();
      allow create, delete: if isAdmin();
    }

    // ============================================
    // Audit Logs
    // ============================================
    match /auditLogs/{logId} {
      allow read: if isAdmin();
      allow create: if isEditorOrAdmin();
      allow update, delete: if false;
    }

    // ============================================
    // Notes Collection
    // ============================================
    match /notes/{noteId} {
      allow read: if isActiveUser();
      allow create: if isEditorOrAdmin();
      allow update: if isActiveUser() && (
        resource.data.createdBy == request.auth.uid || isAdmin()
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // Incentive Schemes
    // ============================================
    match /incentiveSchemes/{schemeId} {
      allow read: if isActiveUser();
      allow write: if isAdmin();
    }

    // ============================================
    // Settings
    // ============================================
    match /settings/{settingId} {
      allow read: if isActiveUser();
      allow write: if isAdmin();
    }
  }
}
